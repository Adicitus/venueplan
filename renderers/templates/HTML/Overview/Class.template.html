<<

$cd = $Class.course_date
$week = @("M", "T", "O", "T", "F")
$sd = $cd.cint_startdate
$ed = $cd.cint_enddate
$si = $sd.DayOfWeek.value__
$ei = $ed.DayOfWeek.value__

for ($i = 1; $i -le 5; $i++) {
	if ( ($i -lt $si) -or ($i -gt $ei) ) {
		$week[$i-1] = "_"
	}
}

$values.Week = $week -join ""


$renderProperty = {
	param( $c, $l, $v )
	
	Render-Template "$TemplateDir\Property.template.html" @{
		Classes = $c
		Label 	= $l
		Value	= $v
	}
}

$Values.renderProperty = $renderProperty

$renderPreFormatted = {
	param( $c, $v )
	
	Render-Template "$TemplateDir\PreFormatted.template.html" @{
		Classes = $c
		Value	= $v
	}
}

$Values.renderPreFormatted = $renderPreFormatted

$Values.physicalVenues = $_.Venues | ? { $_.Category.cint_name -ne "LiveClass" }

>>

<div class="class">
	<div class="class_status">
		<div class="weekdays"><< $Values.Week >></div>
		<div class="period">
			<< "{0:yyyy-MM-dd HH:mm} -> {1:yyyy-MM-dd HH:mm}" -f $Class.course_date.cint_startdate.ToLocalTime(), $Class.course_date.cint_enddate.ToLocalTime() >>
		</div>
	</div>
	
	<div class="class_nameid">
		<div class="classname">
			<<
				$title = $Class.course_date.cint_name
				
				$titleTrunkated = if ($title.Length -gt (70 - $indent)) {
					$title.substring(0, (68 - $indent)) + ".."
				} else {
					$title
				}
			
				$titleTrunkated
			>>
		</div>
		
		<div class="classid">
			<a
				href="<<
					'http://crm.addskills.se/Cornerstone/main.aspx?etc=10020&extraqs=%3Fetc%3D10020%26id%3D%257b{0}%257d&pagetype=entityrecord' -f $class.course_date.Id
				>>"
				target="<<$class.course_date.id>>"
			>
			<<$Class.course_date.cint_course_datenumber>>
			</a>
		</div>
	</div>
	<div class="class_details">
		
		<<
		
			$renderProperty = $Values.renderProperty
			
			$definitiveStudents = $Class.Reservations | ? { $_.cint_reservationstatus -eq 20 }
			$studentCount = $definitiveStudents | measure | % Count
			$masterStudents = $definitiveStudents | ? { !($_.cs_remote_participant -or $_.cs_course_reservation_id) }
			$studentCountAtHome = $definitiveStudents | ? { $_.cs_remote_participant } | Measure | % Count
			$remoteStudents = @{}
			
			$definitiveStudents | % {
				$s = $_
				if ($s.cs_course_reservation_id) {
					$class.Venues | ? {
						$_.Booking.cint_venue_bookingid -eq $s.cs_course_reservation_id
					} | % {
						$city = $_.Venue.cint_visitingcity
						if (!$remoteStudents[$city]) {
							$remoteStudents[$city] = @()
						}
						
						$remoteStudents[$city] += $s
					}
				}
			}
			
			$isSatellite = $remoteStudents.Keys -contains $SiteName
			$isMaster = !$isSatellite -and ( ($remoteStudents.Keys -gt 0) -or ($studentCountAtHome -gt 0) )
			
			$localStudentCount = if ($isSatellite) {
				$remoteStudents[$SiteName] | measure | % Count
			} else {
				$masterStudents | measure | % Count
			}
			
			$atHomeValue = if ($studentCountAtHome) { ("{0}x@Home" -f $studentCountAtHome) } else { "" }
			$satelliteValue = ($remoteStudents.Keys | % { "{1}x {0}" -f $_, $remoteStudents[$_].Count }) -join " "
			$localStudentValue = if ($isSatellite) { "{0} [LC]" -f $localStudentCount } else { "{0}" -f $localStudentCount }
			$v = if ($isSatellite -or !$isMaster) {
				"{0}" -f @(
					$localStudentValue
				)
			} else {
				"{0} + {1} {2}" -f @(
					$localStudentValue,
					$atHomeValue,
					$satelliteValue
				)
			}
			
			& $renderProperty "reservations" "Deltagare:" $v
			
			
			$isChild = $null -ne $Class.Meta.Relations.ChildOf
			
			if (!$isChild) {
				
				& $renderProperty "instructorname" "InstruktÃ¶r:" $Class.course_date.cint_teachers
			
				$cd = $Class.course_date
				
				if ($cd.cint_city) {
					& $renderProperty "" "Ort:" $cd.cint_city
				}
				
				if ($cd.cs_version) {
					& $renderProperty "" "Version:" $cd.cs_version
				}
				
				if ($cd.cint_course_code) {
					& $renderProperty "" "Kurskod:" $cd.cint_course_code
				}
				
				& $renderProperty "" "Lokaler KrÃ¤vs:" ($cd.cint_requirevenuebooking_FormattedValue)
				
				if ($cd.cint_requirevenuebooking) {
					$vc = $Values.physicalVenues | measure | % Count
					$c = if ($vc -eq 0) { "failed" } else { "passed" }
					& $renderProperty "$c" "Lokaler:" ($Values.physicalVenues | measure | % Count)
				}
			}
			
		>>
	</div>
	
	<div class="venues <<if($cd.cint_requirevenuebooking){'hidden'}>>">
		<<
			$Values.physicalVenues | Sort { $_.Venue.Name } | % {
				$venue = $_
				
				Render-Template "$TemplateDir\Venue.template.html" @{
					Venue = $venue
				}
			}
		>>
	</div>
	
	<div class="class_notes ">
		<div class="course_notes << if (!$Class.CourseNoteAnnotations) { 'hidden' } >>">
<<
	$Class.CourseNoteAnnotations | % {
		& $Values.renderPreFormatted "note" $_.notetext
	}
>>
		</div>
		
		<div class="course_date_notes << if (!$Class.CourseDateNoteAnnotations) { 'hidden' } >>">
<<
	$Class.CourseDateNoteAnnotations | % {
		& $Values.renderPreFormatted "note" $_.notetext
	}
>>
		</div>
	</div>
	
	<div class="class_meta">
		<div class="course_meta">
<<
	$Class.CourseMetaAnnotations | % {
		& $Values.renderPreFormatted "metadata" $_.notetext
	}
>>
		</div>
		<div class="course_date_meta">
<<
	$Class.CourseDateMetaAnnotations | % {
		& $Values.renderPreFormatted "metadata" $_.notetext
	}
>>
		</div>
	</div>
	
	<div class="children << if (!$Class.Children)  { 'hidden' } >>">
		<<
		if ($children = $Class.Children) {
			$children | % {
				$child = $_
				Render-Template "$TemplateDir\Class.template.html" @{
					Class = $child
				}
			}
		}
		>>
	</div>
</div>
